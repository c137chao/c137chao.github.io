<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>6.s081 lab10 mmap - Summer Blog Space</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="notebook on 6.s081 lab">
		<meta property="og:title" content="6.s081 lab10 mmap" />
<meta property="og:description" content="notebook on 6.s081 lab" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://c137chao.github.io/6.s081/lab10-mmap/" /><meta property="article:section" content="6.s081" />
<meta property="article:published_time" content="2021-02-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-02-05T00:00:00+00:00" />


		<meta itemprop="name" content="6.s081 lab10 mmap">
<meta itemprop="description" content="notebook on 6.s081 lab"><meta itemprop="datePublished" content="2021-02-05T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-02-05T00:00:00+00:00" />
<meta itemprop="wordCount" content="1249">
<meta itemprop="keywords" content="Operating System," />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="summer" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="https://pic.imgdb.cn/item/651e2920c458853aef0fc060.jpg">
				</div><div class="logo__item logo__text">
					<div class="logo__title">summer</div>
					<div class="logo__tagline">summer blog space</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/blog/axglyph/">
				
				<span class="menu__text">Axglyph 学习记录</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog/cs162-proj1/">
				
				<span class="menu__text">CS162 Project1 Userprograme</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/cs61/cs61b-gitlet/">
				
				<span class="menu__text">CS61B-实现一个简易的git</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog/cs61c-cpu/">
				
				<span class="menu__text">CS61C-简易的二级流水risv-v CPU</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog/tinykv-lab2a/">
				
				<span class="menu__text">tinykv lab2a raft</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog/tinykv-lab2b/">
				
				<span class="menu__text">tinykv lab2b kvraft</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog/tinykv-lab2c/">
				
				<span class="menu__text">tinykv lab2c snapshot</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/blog/tinykv-lab3/">
				
				<span class="menu__text">tinykv lab3</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">6.s081 lab10 mmap</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Summer</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2021-02-05T00:00:00Z">February 05, 2021</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/6.s081/" rel="category">6.s081</a>
	</span>
</div></div>
		</header>
		
	<figure class="post__thumbnail thumbnail">
		
		<img class="thumbnail__image" src="https://pic.imgdb.cn/item/6520d45ac458853aef1079fb.jpg" alt="6.s081 lab10 mmap">
		
	</figure><div class="content post__content clearfix">
			<h1 id="lab-10---mmap">lab 10 - mmap</h1>
<blockquote>
<p>这个实验看的人头皮发麻，不过已经最后一个虚拟地址的实验了，实验接近尾声了，冲冲冲！！！</p>
</blockquote>
<p><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/mmap.html">官方实验指导书传送门</a></p>
<hr>
<p>=================以下是完成实验时比较详细的记录===============</p>
<p>其实刚开始做还是有点一头雾水的，先看一下mmap的文档</p>
<p>linux中mmap与munmapd的接口格式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/*
</span><span style="color:#75715e">addr: 文件要映射到的起始地址，NULL表示内核自己选择合适的地址。
</span><span style="color:#75715e">len : 是映射到调用进程地址空间的字节数，它从被映射文件开头offset个字节开始算起。
</span><span style="color:#75715e">prot: 参数指定共享内存的访问权限。PROT_READ , PROT_WRITE, PROT_EXEC , PROT_NONE。
</span><span style="color:#75715e">flags:决定本次映射其他进程是否可见。
</span><span style="color:#75715e">      MAP_SHARED,其他进程共享该文件，如果修改了要写回文件
</span><span style="color:#75715e">      MAP_PRIVATE, 使用完文件不用写回
</span><span style="color:#75715e">      MAP_SHARED_VALIDATE(linux 4.15后)，类似MAP_SHARED，只不过MAP_SHARED会忽略未知的标记，MAP_SHARED_VALIDATE会检查
</span><span style="color:#75715e">fd:   文件描述符
</span><span style="color:#75715e">offset:文件的偏移量，必须是页面大小的倍数，mmaptest里offset全都是0，表示从文件头开始映射。
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">// mmap将文件映射到内存，返回其在内存的区域
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mmap</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, size_t length, <span style="color:#66d9ef">int</span> prot, <span style="color:#66d9ef">int</span> flags,<span style="color:#66d9ef">int</span> fd, off_t offset);

<span style="color:#75715e">//addr 必须是页面大小的倍数，length不要求，成功返回0，失败返回-1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">munmap</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, size_t length);
</code></pre></div><p>原本xv6读写文件都是通过磁盘块读到内存的缓冲区，然后通过缓冲区对文件进行读写操作，并且缓冲区必须通过内核来使用，而mmap将文件映射到内存，用户可以直接通过地址来访问。</p>
<p>拆解一下实验</p>
<p>第一部分，配置好系统调用相关(略过)</p>
<ul>
<li>Start by adding _mmaptest to UPROGS, and mmap and munmap system calls, in order to get user/mmaptest.c to compile. For now, just return errors from mmap and munmap. We defined PROT_READ etc for you in kernel/fcntl.h. Run mmaptest, which will fail at the first mmap call.</li>
</ul>
<hr>
<p>第二部分，让mmaptest跑到munmap</p>
<ul>
<li>使用lazy allocation, mmap只增加proc的size，而不去做具体的分配和映射，实际的内存分配在usertrap里来进行。</li>
<li>增加VMA结构，表示一段连续的内存区域，这段内存区域的权限都是一样的(课上提过)，要包括指向映射文件对应struct file的指针，其创建的内存范围的地址，长度，访问权限等等，因为一个VMA管理一个文件，然后还要涉及到查找什么的，这里就涉及到VMA之间的结构组织，指导书里提到本实验里将其声明称一个大小为16的数组就足够了。</li>
<li>Implement mmap: find an unused region in the process&rsquo;s address space in which to map the file, and add a VMA to the process&rsquo;s table of mapped regions. The VMA should contain a pointer to a struct file for the file being mapped; mmap should increase the file&rsquo;s reference count so that the structure doesn&rsquo;t disappear when the file is closed (hint: see filedup). Run mmaptest: the first mmap should succeed, but the first access to the mmap-ed memory will cause a page fault and kill mmaptest.</li>
<li>Add code to cause a page-fault in a mmap-ed region to allocate a page of physical memory, read 4096 bytes of the relevant file into that page, and map it into the user address space. Read the file with readi, which takes an offset argument at which to read in the file (but you will have to lock/unlock the inode passed to readi). Don&rsquo;t forget to set the permissions correctly on the page. Run mmaptest; it should get to the first munmap.</li>
</ul>
<hr>
<p><strong>第一个问题是设置VMA以及定义其相关操作。</strong></p>
<p>百度了一下Linux中的VMA为了能快速查找，是以红黑树和链表两种结构组织的(复杂X.X)，然后每个进程持有一颗红黑树，实验里我们只需要设置成一个大小为16的数组。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">// 先定义成这样，看情况再修改
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> VMA{
  <span style="color:#75715e">// 只有一个进程持有，暂时没有涉及到竞争
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// struct spinlock lock;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> file<span style="color:#f92672">*</span> file; <span style="color:#75715e">// if file is NULL, mean free 
</span><span style="color:#75715e"></span>  uint64 addr;    <span style="color:#75715e">// file addr in mmeory
</span><span style="color:#75715e"></span>  uint64 length;  <span style="color:#75715e">// file size
</span><span style="color:#75715e"></span>  uint64 offset;  <span style="color:#75715e">// file offset (all 0 in mmaptest)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span>    prot;    <span style="color:#75715e">// None, read, write, excuate
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span>    flag;    <span style="color:#75715e">// MAP_SHARED, MAP_PRIvaTE
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// int    fd;      // file describe，文件描述符并没有用到，可以删掉
</span><span style="color:#75715e"></span>};

<span style="color:#66d9ef">struct</span> proc{
<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span> vma[<span style="color:#ae81ff">16</span>];
<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// 
</span></code></pre></div><p>在procinit里初始化VMA，当然更为安全的办法是在allocproc的时候初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">procinit</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
  
  initlock(<span style="color:#f92672">&amp;</span>pid_lock, <span style="color:#e6db74">&#34;nextpid&#34;</span>);
  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> proc; p <span style="color:#f92672">&lt;</span> <span style="color:#f92672">&amp;</span>proc[NPROC]; p<span style="color:#f92672">++</span>) {
      initlock(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock, <span style="color:#e6db74">&#34;proc&#34;</span>);
      p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">=</span> KSTACK((<span style="color:#66d9ef">int</span>) (p <span style="color:#f92672">-</span> proc));
      <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>){
        p<span style="color:#f92672">-&gt;</span>vma[i].file <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>;
      }
  }
}
</code></pre></div><p><strong>修改mmap</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">uint64
<span style="color:#a6e22e">sys_mmap</span>()
{
  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> myproc();
  <span style="color:#66d9ef">struct</span> VMA<span style="color:#f92672">*</span> vm_area <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>vma;
  <span style="color:#75715e">// find a free vma 
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(; vm_area <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">-&gt;</span>vma <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">&amp;&amp;</span> vm_area<span style="color:#f92672">-&gt;</span>file; vm_area<span style="color:#f92672">++</span> );
  <span style="color:#75715e">// didn&#39;t find
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(vm_area <span style="color:#f92672">==</span> p<span style="color:#f92672">-&gt;</span>vma <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>)  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

  <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>mmap_file;

  uint64 addr; 
  <span style="color:#66d9ef">int</span> length, prot, flags, fd, offset;

  <span style="color:#66d9ef">if</span>(argaddr(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>addr) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> argint(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>length) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> argint(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>prot) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
       argint(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">&amp;</span>flags) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> argfd(<span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>fd, <span style="color:#f92672">&amp;</span>mmap_file) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> argint(<span style="color:#ae81ff">5</span>, <span style="color:#f92672">&amp;</span>offset) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

  vm_area<span style="color:#f92672">-&gt;</span>file <span style="color:#f92672">=</span> mmap_file;

  <span style="color:#66d9ef">if</span>(addr <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
    addr <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>sz;
  }
  vm_area<span style="color:#f92672">-&gt;</span>addr <span style="color:#f92672">=</span> addr;
  vm_area<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">=</span> length;
  vm_area<span style="color:#f92672">-&gt;</span>prot <span style="color:#f92672">=</span> prot;
  vm_area<span style="color:#f92672">-&gt;</span>flag <span style="color:#f92672">=</span> flags;
  vm_area<span style="color:#f92672">-&gt;</span>offset <span style="color:#f92672">=</span> offset;
  <span style="color:#75715e">// 打印一些信息方便找bug
</span><span style="color:#75715e"></span>  printf(<span style="color:#e6db74">&#34;[sys mmap]: addr %p, length %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (uint64<span style="color:#f92672">*</span>)vm_area<span style="color:#f92672">-&gt;</span>addr, vm_area<span style="color:#f92672">-&gt;</span>length);
  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">+=</span> length;

  filedup(vm_area<span style="color:#f92672">-&gt;</span>file);

  <span style="color:#66d9ef">return</span> (uint64)vm_area<span style="color:#f92672">-&gt;</span>addr;
}

uint64
<span style="color:#a6e22e">sys_munmap</span>()
{ 
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>这个时候运行mmaptest</p>
<p><img src="MIT6.s081Operating%20System/lab%2010%20-%20mmap/image/image.png" alt=""></p>
<p><strong>结果正如预期，下面去修改usertrap</strong></p>
<p>增加一个辅助函数，查找发生usertrap的地址是否被某个VMA所管理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">struct</span> VMA<span style="color:#f92672">*</span> <span style="color:#a6e22e">find_vma</span>(<span style="color:#66d9ef">struct</span> VMA<span style="color:#f92672">*</span> vma, uint64 addr){
  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>){
    <span style="color:#66d9ef">if</span>(addr <span style="color:#f92672">&gt;=</span> vma[i].addr <span style="color:#f92672">&amp;&amp;</span> addr <span style="color:#f92672">&lt;</span> (vma[i].addr <span style="color:#f92672">+</span> vma[i].length))
      <span style="color:#66d9ef">return</span> vma <span style="color:#f92672">+</span> i;
  }
  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>) <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>完善usertrap</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#75715e">//....
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(r_scause() <span style="color:#f92672">==</span> <span style="color:#ae81ff">13</span> <span style="color:#f92672">||</span> r_scause() <span style="color:#f92672">==</span> <span style="color:#ae81ff">15</span>) {
    uint64 va <span style="color:#f92672">=</span> r_stval();
    printf(<span style="color:#e6db74">&#34;[usertrap]: va %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (uint64<span style="color:#f92672">*</span>)va);

    <span style="color:#75715e">// find vma if exit one contain va
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span>vm_area <span style="color:#f92672">=</span> find_vma(p<span style="color:#f92672">-&gt;</span>vma, va);
  
    <span style="color:#66d9ef">if</span>(vm_area <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
      <span style="color:#75715e">//didn&#39;t find
</span><span style="color:#75715e"></span>      p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#75715e">// permission safe ？？？  
</span><span style="color:#75715e"></span>      uint64 ka <span style="color:#f92672">=</span> (uint64)kalloc();
      <span style="color:#66d9ef">if</span>(ka <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){ 
        printf(<span style="color:#e6db74">&#34;usertrap : kalloc failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
      } <span style="color:#66d9ef">else</span>{
        <span style="color:#75715e">// 如果没有 memset 会出问题
</span><span style="color:#75715e"></span>        memset((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)ka, <span style="color:#ae81ff">0</span>, PGSIZE);
        va <span style="color:#f92672">=</span> PGROUNDDOWN(va);
        ilock(vm_area<span style="color:#f92672">-&gt;</span>file<span style="color:#f92672">-&gt;</span>ip);
        readi(vm_area<span style="color:#f92672">-&gt;</span>file<span style="color:#f92672">-&gt;</span>ip, <span style="color:#ae81ff">0</span>, ka, 
			  va <span style="color:#f92672">-</span> vm_area<span style="color:#f92672">-&gt;</span>addr <span style="color:#f92672">-</span> vm_area<span style="color:#f92672">-&gt;</span>offset, PGSIZE);
        iunlock(vm_area<span style="color:#f92672">-&gt;</span>file<span style="color:#f92672">-&gt;</span>ip);

        <span style="color:#66d9ef">if</span>( mappages(p<span style="color:#f92672">-&gt;</span>pagetable, va, PGSIZE, ka, PTE_U <span style="color:#f92672">|</span> (vm_area<span style="color:#f92672">-&gt;</span>prot <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
          kfree((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)ka);
          p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        } 
      }
    }
  } <span style="color:#75715e">// ....
</span><span style="color:#75715e"></span>}
</code></pre></div><p><img src="MIT6.s081Operating%20System/lab%2010%20-%20mmap/image/image_1.png" alt=""></p>
<p><strong>nice, 下一步</strong></p>
<ul>
<li>Implement munmap: find the VMA for the address range and unmap the specified pages (hint: use uvmunmap). If munmap removes all pages of a previous mmap, it should decrement the reference count of the corresponding struct file. If an unmapped page has been modified and the file is mapped MAP_SHARED, write the page back to the file. Look at filewrite for inspiration.</li>
<li>Ideally your implementation would only write back MAP_SHARED pages that the program actually modified. The dirty bit (D) in the RISC-V PTE indicates whether a page has been written. However, mmaptest does not check that non-dirty pages are not written back; thus you can get away with writing pages back without looking at D bits.</li>
</ul>
<p><strong>修改munmap</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">uint64
<span style="color:#a6e22e">sys_munmap</span>()
{ 
  uint64 addr;
  <span style="color:#66d9ef">int</span>  length;
  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> myproc();
  
  <span style="color:#66d9ef">if</span>(argaddr(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>addr) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> argint(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>length) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

  <span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span>vm_area <span style="color:#f92672">=</span> find_vma(p<span style="color:#f92672">-&gt;</span>vma, addr);
  <span style="color:#66d9ef">if</span>(vm_area<span style="color:#f92672">-&gt;</span>flag <span style="color:#f92672">&amp;</span> MAP_SHARED){
    <span style="color:#75715e">// 未完成
</span><span style="color:#75715e"></span>    filewrite(vm_area<span style="color:#f92672">-&gt;</span>file, addr, length);
  }
  uvmunmap(p<span style="color:#f92672">-&gt;</span>pagetable, addr, length, <span style="color:#ae81ff">1</span>);
  vm_area<span style="color:#f92672">-&gt;</span>addr <span style="color:#f92672">+=</span> length;
  vm_area<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">-=</span> length;
  <span style="color:#66d9ef">if</span>(vm_area<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
    fileclose(vm_area<span style="color:#f92672">-&gt;</span>file);
    vm_area<span style="color:#f92672">-&gt;</span>file <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>;
  }
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p><img src="MIT6.s081Operating%20System/lab%2010%20-%20mmap/image/image_2.png" alt=""></p>
<p>原因是用PORT_WRITE映射了只读的文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//....mmaptest
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> ((fd <span style="color:#f92672">=</span> open(f, O_RDONLY)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    err(<span style="color:#e6db74">&#34;open&#34;</span>);
p <span style="color:#f92672">=</span> mmap(<span style="color:#ae81ff">0</span>, PGSIZE<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>, PROT_READ <span style="color:#f92672">|</span> PROT_WRITE, MAP_SHARED, fd, <span style="color:#ae81ff">0</span>);
</code></pre></div><p>所以在sys_map里加上这样一个判断</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">if</span>((flags <span style="color:#f92672">&amp;</span> MAP_SHARED) <span style="color:#f92672">&amp;&amp;</span> (prot <span style="color:#f92672">&amp;</span> PROT_WRITE) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">!</span>mmap_file<span style="color:#f92672">-&gt;</span>writable) )
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</code></pre></div><p><img src="MIT6.s081Operating%20System/lab%2010%20-%20mmap/image/image_3.png" alt=""></p>
<p>回去处理一下&quot;小尾巴&quot;，让文件只写回脏页(参照filewrite)</p>
<p>xv6页表项没有定义脏位，手动添加他
![[Pasted image 20220223174657.png]]</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// risv.h
</span><span style="color:#75715e"></span><span style="color:#75715e">#define PTE_D (1L &lt;&lt; 7)
</span></code></pre></div><p>然后设置更新脏位，就是usertap中如果发生了写错误，并且这是一个VMA管理的地址，就设置dirty bit，在mappages去做修改。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">mappages</span>(pagetable_t pagetable, uint64 va, uint64 size, uint64 pa, <span style="color:#66d9ef">int</span> perm)
{
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span>(;;){
		<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(r_scause() <span style="color:#f92672">==</span> <span style="color:#ae81ff">15</span>) <span style="color:#f92672">*</span>pte<span style="color:#f92672">=</span> PA2PTE(pa) <span style="color:#f92672">|</span> PTE_D;
		<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>	}
	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

}
</code></pre></div><p>第二就是写回的时候判断脏位，本来想在filewrite中去修改，但因为要检查脏位，就必须获取页表项，想了想也没找到合适的地方去改，最后干脆不是在filewrite中增加dirty bit的检查，而是将filewrite增加到需要调用walk的uvmunmap里去。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">vmaunmap</span>(<span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span>vma, pagetable_t pagetable, uint64 va, uint64 npages, <span style="color:#66d9ef">int</span> do_free)
{
uint64 a;
pte_t <span style="color:#f92672">*</span>pte;

<span style="color:#66d9ef">if</span>((va <span style="color:#f92672">%</span> PGSIZE) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
	panic(<span style="color:#e6db74">&#34;vmaunmap: not aligned&#34;</span>);
  
<span style="color:#66d9ef">for</span>(a <span style="color:#f92672">=</span> va; a <span style="color:#f92672">&lt;</span> va <span style="color:#f92672">+</span> npages<span style="color:#f92672">*</span>PGSIZE; a <span style="color:#f92672">+=</span> PGSIZE){
	<span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> walk(pagetable, a, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
		<span style="color:#66d9ef">continue</span>;  <span style="color:#75715e">// 表明该页面从来没有使用过，进而也就没被分配过
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
		<span style="color:#66d9ef">continue</span>;
	<span style="color:#66d9ef">if</span>(PTE_FLAGS(<span style="color:#f92672">*</span>pte) <span style="color:#f92672">==</span> PTE_V)
		panic(<span style="color:#e6db74">&#34;vmaunmap: not a leaf&#34;</span>);
	<span style="color:#66d9ef">if</span>((vma<span style="color:#f92672">-&gt;</span>flag <span style="color:#f92672">&amp;</span> MAP_SHARED) <span style="color:#f92672">&amp;&amp;</span> (PTE_FLAGS(<span style="color:#f92672">*</span>pte) <span style="color:#f92672">&amp;</span> PTE_D) ){
		<span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
		<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span> f <span style="color:#f92672">=</span> vma<span style="color:#f92672">-&gt;</span>file;
		<span style="color:#75715e">// write back to file on disk
</span><span style="color:#75715e"></span>		begin_op();
		ilock(f<span style="color:#f92672">-&gt;</span>ip);
		<span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> writei(f<span style="color:#f92672">-&gt;</span>ip, <span style="color:#ae81ff">1</span>, a, f<span style="color:#f92672">-&gt;</span>off, PGSIZE)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
		f<span style="color:#f92672">-&gt;</span>off <span style="color:#f92672">+=</span> r;
		iunlock(f<span style="color:#f92672">-&gt;</span>ip);
		end_op();
	}
	<span style="color:#66d9ef">if</span>(do_free){
	uint64 pa <span style="color:#f92672">=</span> PTE2PA(<span style="color:#f92672">*</span>pte);
	kfree((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pa);
}
<span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}

}
</code></pre></div><p>最后一部分</p>
<ul>
<li>exit to unmap the process&rsquo;s mapped regions as if munmap had been called. Run mmaptest; mmap_test should pass, but probably not fork_test.</li>
<li>Modify fork to ensure that the child has the same mapped regions as the parent. Don&rsquo;t forget to increment the reference count for a VMA&rsquo;s struct file. In the page fault handler of the child, it is OK to allocate a new physical page instead of sharing a page with the parent. The latter would be cooler, but it would require more implementation work. Run mmaptest; it should pass both mmap_test and fork_test.</li>
</ul>
<p><strong>exit</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">exit</span>(<span style="color:#66d9ef">int</span> status)
{
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// munmap all vma
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> VMA<span style="color:#f92672">*</span> vma <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>vma;
  <span style="color:#66d9ef">for</span>(; vma <span style="color:#f92672">&lt;</span> p<span style="color:#f92672">-&gt;</span>vma <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>; vma<span style="color:#f92672">++</span>){
    <span style="color:#66d9ef">if</span>(vma<span style="color:#f92672">-&gt;</span>file){
      uvmunmap(p<span style="color:#f92672">-&gt;</span>pagetable, vma<span style="color:#f92672">-&gt;</span>addr, vma<span style="color:#f92672">-&gt;</span>length, <span style="color:#ae81ff">1</span>);

      <span style="color:#75715e">// fileclose(vma-&gt;file);
</span><span style="color:#75715e"></span>      vma<span style="color:#f92672">-&gt;</span>file <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>;
    }
  }
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p><strong>fork</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">fork</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#75715e">// ....
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>){
    np<span style="color:#f92672">-&gt;</span>vma[i] <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>vma[i];
  }
  <span style="color:#75715e">// ....
</span><span style="color:#75715e"></span>}
</code></pre></div><p><strong>uvmcopy</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">uvmcopy</span>(pagetable_t old, pagetable_t new, uint64 sz)
{
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i <span style="color:#f92672">+=</span> PGSIZE){
    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> walk(old, i, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
      panic(<span style="color:#e6db74">&#34;uvmcopy: pte should exist&#34;</span>);
    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
      <span style="color:#66d9ef">continue</span>;
      <span style="color:#75715e">//panic(&#34;uvmcopy: page not present&#34;);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//....
</span><span style="color:#75715e"></span>  }
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

 err:
  uvmunmap(new, <span style="color:#ae81ff">0</span>, i <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>暂时粗糙的完成了
![[Pasted image 20220223190741.png]]
sys_munmap很多地方我觉得处理的都很粗糙，因为mmaptest里面的调用参数都很整齐，偷懒了就。</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/operating-system/" rel="tag">Operating System</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Summer avatar" src="https://pic.imgdb.cn/item/651e2920c458853aef0fc060.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Summer</span>
	</div>
	<div class="authorbox__description">
		newbie programer
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/6.s081/lab9-filesys/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">6.s081 lab9 filesys</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/6.s081/lab11-network/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">6.s081 lab11 network</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://www.bing.com/">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH…" value="" name="q" aria-label="SEARCH…">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://c137chao.github.io/">
	</form>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/blog/axglyph/">Axglyph 学习记录</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog/tinykv-lab2c/">tinykv lab2c snapshot</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog/tinykv-lab2b/">tinykv lab2b kvraft</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog/tinykv-lab2a/">tinykv lab2a raft</a></li>
			<li class="widget__item"><a class="widget__link" href="/blog/cs162-proj1/">CS162 Project1 Userprograme</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/distribute-storage/" title="distribute storage">distribute storage</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/operating-system/" title="Operating System">Operating System</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Summer.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>